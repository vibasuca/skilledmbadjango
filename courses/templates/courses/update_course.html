<!-- product_form.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Management</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Save as draft</button>
        <button type="submit" name="submit_for_review">Submit for review</button>
      </form>
      <div id="topic-list">
        <h2>Course builder</h2>
        <form id="topic-create-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" class="form-control" id="title" name="title">
            </div>
            <div class="form-group">
                <label for="summary">Summary:</label>
                <textarea class="form-control" id="summary" name="summary"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">Create Topic</button>
        </form>

        <hr>
        <div id="accordion">
            <!-- Topics items will be dynamically added here -->
        </div>

      </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
             

          // AJAX Upload Form
          $("#topic-create-form").submit(function(e) {
            e.preventDefault();
            const form = $(this);
            const url = "{% url 'courses:create_topic' course.pk %}";

            $.ajax({
                type: "POST",
                url: url,
                data: new FormData(this),
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                processData: false,
                contentType: false,
                success: function(response) {
                    alert(response.message);
                    // Refresh media list after successful upload
                    fetchTopicsList();
                },
                error: function(xhr, status, error) {
                    alert("Error: " + xhr.responseJSON.error);
                    // Handle the error and update the UI accordingly
                },
            });
        });

            // Function to fetch and display the topics list
            function fetchTopicsList() {
                const url = "{% url 'courses:list_topics' course.pk %}";

                $.ajax({
                    type: "GET",
                    url: url,
                    success: function(response) {
                        const topicList = response.topics;
                        const topicListContainer = $("#topic-list #accordion");
                        topicListContainer.empty();

                        topicList.forEach(function(topic, index) {
                            
                            const topicElement = `
                            <div class="card">
                                <div class="card-header" id="heading${index}">
                                  <h5 class="mb-0">
                                    <button class="btn btn-link" data-toggle="collapse" data-target="#collapse${index}" aria-expanded="true" aria-controls="collapse${index}">
                                        ${topic.title}
                                    </button>
                                  </h5>
                                </div>
                          
                                <div id="collapse${index}" class="collapse" aria-labelledby="heading${index}" data-parent="#accordion">
                                  <div class="card-body">
                                    <div class="form-group">
                                        <label for="title">Title:</label>
                                        <input type="text" class="form-control" id="title-${topic.id}" value="${topic.title}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="summary">Summary:</label>
                                        <textarea class="form-control" id="summary-${topic.id}">${topic.summary}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="sort_order">Sort order:</label>
                                        <input type="text" class="form-control" id="sort_order-${topic.id}" value="${topic.sort_order}">
                                    </div>
                                    <button class="btn btn-primary update-topic-btn" data-topic-id="${topic.id}">Update</button>
                                  </div>
                                </div>
                              </div>
                            `;
                            topicListContainer.append(topicElement);

                        });
                    },
                    error: function(xhr, status, error) {
                        alert("Error fetching topic list.");
                    },
                });
            }

            // Function to update media
            function updateTopic(topicId, newData) {
                $.ajax({
                    type: "POST",
                    url: `/courses/update-topic/${topicId}/`, // URL to the update_media view
                    data: newData,
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    success: function(response) {
                        alert("Topic updated successfully!");
                        fetchTopicsList(); // Refresh the media list after successful update
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred while updating topic.");
                    },
                });
            }

            // Event listener for updating media
            $(document).on("click", ".update-topic-btn", function() {
                const topicId = $(this).data("topic-id");
                const newData = {
                    title: $(`#title-${topicId}`).val(),
                    summary: $(`#summary-${topicId}`).val(),
                    sort_order: $(`#sort_order-${topicId}`).val(),
                };
                updateTopic(topicId, newData);
            });

            // Fetch the media list when the page loads
            fetchTopicsList();
        });

    </script>
</body>
</html>




  