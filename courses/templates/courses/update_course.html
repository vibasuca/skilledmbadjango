{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Skilled MBA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />

  <link rel="stylesheet" href="{% static 'fonts/fontawesome-all.min.css' %}" />
  <link rel="stylesheet" href="{% static 'fonts/tutor-icons.css' %}" />

  <link rel="stylesheet" id="custom-stylesheet-css" type="text/css" media="all"
    href="{% static 'css/dashboard.css' %}" />

  <!-- ✅ Load CSS file for Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- ✅ load jQuery ✅ -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

  <!-- ✅ load JS for Select2 ✅ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"
    integrity="sha512-2ImtlRlf2VVmiGZsjm9bEyhjGW4dU7B6TNwh/hx/iSByxNENtj3WVE6o/9Lj4TJeVXPi4bnOIMXFIJJAeufa0A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
</head>

<body style="background: #f8f8f8">
  <!-- Header -->
  <header id="myNavbar" class="shadow-sm bg-white position-sticky top-0" style="z-index: 10">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3 gap-lg-4">
        <div class="p-3 d-flex">
          <img class="brandingLogo m-auto" src="{% static 'images/logo.png' %}" loading="lazy" />
        </div>
        <button class="saveDraft btn btn-outline-primary px-lg-3 py-lg-2" type="submit" form="courseForm">
          <i class="fal fa-save"></i>
          <span>&nbsp;&nbsp;Save</span>
        </button>
      </div>
      <div class="d-flex align-items-center gap-2 gap-lg-4">
        <a class="btn btn-light text-muted border border-2 px-lg-4 px-3 py-2 d-none d-lg-inline" href="{% url 'courses:course_details' course.pk course.slug %}">
          <i class="fal fa-glasses"></i>
          <span class="d-none d-lg-inline">&nbsp;&nbsp;&nbsp;Preview</span>
        </a>
        <button class="btn btn-primary px-lg-4 px-3 py-2 d-none d-lg-inline" type="submit" form="courseForm"
          name="submit_for_review">
          <span class="d-none d-lg-inline"><b>Submit for Review</b></span>
        </button>
        <a href="{% url 'account_profile' %}">
          <button class="btn btn-outline-danger px-lg-4 px-3 py-2 d-none d-lg-inline">
            <span class="d-lg-inline"> Exit </span>
          </button>
        </a>
        <button class="btn btn-light border px-3 py-2 d-lg-none" data-bs-toggle="modal" data-bs-target="#navModal">
          <i class="far fa-bars fs-5"></i>
        </button>
      </div>
    </div>
  </header>

  <span class="position-absolute trigger"></span>

  <div class="modal fade" id="navModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="bottom: 0%">
      <div class="modal-content p-3">
        <div class="d-flex flex-column gap-3">
          <a class="btn btn-light border border-2 text-muted px-3 py-2" href="{% url 'courses:course_details' course.pk course.slug %}">
            <i class="fal fa-glasses"></i>
            <span>&nbsp;&nbsp;&nbsp;Preview</span>
          </a>
          <button class="btn btn-primary px-3 py-2">
            <span><b>Submit for Review</b></span>
          </button>
          <button class="btn btn-outline-danger px-3 py-2">
            <span>Discard and Exit</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  {% if messages%}
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} rounded-0 mb-0 d-flex align-items-center justify-content-between">
    <span>
      {{ message }}
    </span>
    <button type="button" class="close btn btn-outline-{{ message.tags }}" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  {% endfor %}
  {% endif%}

  <div class="container py-4">
    <div class="row">
      <div class="col-lg-8 pt-3">
        <form method="post" id="courseForm" enctype="multipart/form-data">
          {% csrf_token %} {% include 'courses/allinone.html' %}
        </form>

        <div class="d-flex py-3 justify-content-between">
          <button form="courseForm" type="submit" class="saveDraft btn bg-white border border-2 text-primary px-3 py-2">
            <span><b>Save course as draft</b></span>
          </button>
          <button form="courseForm" type="submit" name="submit_for_review" class="btn btn-primary px-3 py-2">
            <span><b>Submit for Review</b></span>
          </button>
        </div>
      </div>
      <div class="col-lg-4 pt-3">
        <div class="card text-start sticky-top bg-white" style="top: 12.5%; z-index: 10">
          <div class="card-body tips p-4">
            <span class="fs-4">
              <i class="far fa-lg fa-lightbulb-on text-primary"></i>
              &nbsp;&nbsp;Course Prerequisites
            </span>
            <ul>
              <li>Set the Course Price option or make it free.</li>
              <li>Standard size for course thumbnail is 700x430.</li>
              <li>Video section controls the course overview video.</li>
              <li>Course Builder is where you create & organize a course.</li>
              <li>
                Add Topics in the Course Builder section to create lessons,
                quizzes, and assignments.
              </li>
              <li>
                Prerequisites refers to the fundamental courses to complete
                before taking this particular course.
              </li>
              <li>
                Information from the Additional Data section shows up on the
                course single page.
              </li>
              <li>
                Make Announcements to notify any important notes to all
                enrolled students at once.
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!---------------- Modals ---------------->

  <!-- Media Managerment -->
  <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true"
    style="z-index: 99999999999">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h1 class="modal-title fs-5" id="mediaModalLabel">
            Media Management
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          {% include 'media_library/mediaManagement.html' %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button id="use-media-btn-js" type="button" class="btn btn-primary">Select Media</button>
        </div>
      </div>
    </div>
  </div>

  {% include 'courses/modals.html' %}

  <!-- Update Topic -->
  <div class="modal fade" id="updateTopicModal" tabindex="-1" aria-labelledby="updateTopicModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="updateTopicModalLabel">
            Edit Topic
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="updateTopicForm" method="POST">
          <input class="d-none" type="text" name="topicId" />
          <input class="d-none" type="text" name="sort_order" />

          <div class="modal-body px-4">
            <div class="form-outline mb-3">
              <label class="form-label my-2 fw-bold">Topic Name</label>
              <input type="text" name="title" class="form-control p-3 mb-2" placeholder="Topic Name" required />
              <small class="text-muted">
                <i class="fal fa-info-circle"></i> Topic titles are displayed
                publicly wherever required. Each topic may contain one or more
                lessons, quiz and assignments.
              </small>
            </div>

            <div class="form-outline mb-3">
              <label class="form-label my-2 fw-bold">Topic Summary</label>
              <textarea name="summary" class="form-control p-3 mb-2" rows="3"></textarea>
              <small class="text-muted" required>
                <i class="fal fa-info-circle"></i> Add a summary of short text
                to prepare students for the activities for the topic. The text
                is shown on the course page beside the tooltip beside the
                topic name.
              </small>
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <button id="saveUpdateTopic" type="submit" class="btn btn-primary">
              Save Topic
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Instructor -->
  <div class="modal fade" id="instructorModal" tabindex="-1" aria-labelledby="instructorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="instructorModalLabel">
            Add Instructor
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input id="search-instructor-js" type="text" class="form-control searchInstructorInput mb-3"
            placeholder="Search instructors..." />
          <div id="instructor-list-js">



          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Lesson -->
  <div class="modal fade" id="lessonModal" tabindex="-1" aria-labelledby="lessonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="lessonModalLabel">Lesson</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="lesson-form">
          {% csrf_token %}
          <div class="modal-body px-4">
            <div class="form-outline mb-3">
              <label class="form-label my-2 fw-bold">Lesson Name</label>
              <input type="text" id="lesson-title" name="title" class="form-control p-3 mb-2" value="test title"
                required />
              <small class="text-muted">
                <i class="fal fa-info-circle"></i> Lesson titles are displayed
                publicly wherever required.
              </small>
            </div>

            <div class="form-outline mb-4">
              <label class="form-label my-2 fw-bold">Lesson Content</label>
              <textarea id="lesson-content-editor">
              </textarea>
              <br />
              <small class="text-muted">
                <i class="fal fa-info-circle"></i> The idea of a summary is a
                short text to prepare students for the activities within the
                topic or week. The text is shown on the course page under the
                topic name.
              </small>
            </div>

            <label class="form-label my-2 fw-bold">Feature Image</label>
            <div class="d-flex border rounded">
              <div class="p-3">
                <div class="thumbnail-preview" id="thumbnailPreview">
                  <img id="lesson-feature-image-preview" class="img-fluid"
                    src="{% static 'images/thumbnail-placeholder.svg' %}" alt="thumbnail" />
                </div>
              </div>
              <div class="p-3 d-flex align-items-center" style="width: 100%">
                <span>
                  <b id="imageDimensions">Allowed Size: 700x430 pixels</b>
                  <p>File Support:</p>
                  <select class="d-none" id="lesson-feature_image"></select>
                  <button type="button" class="btn btn-primary" id="lesson-feature_image-btn">
                    Upload Image
                  </button>
                </span>
              </div>
            </div>

            <div class="my-4">
              <div class="card border-0">
                <div class="card-body border border-warning rounded">
                  <i class="far fa-exclamation-circle text-warning fa-lg"></i>&nbsp;&nbsp;No video source selected from
                  settings!
                </div>
              </div>
            </div>

            <div class="form-outline mb-4">
              <label class="form-label my-2 fw-bold">Upload exercise files to the Lesson</label>
              <br>

              {% comment %}
              <div class="card my-3" style="max-width: 350px">
                <div class="card-body">
                  <div class="d-flex flex-column">
                    <b style="font-weight: 500">File name</b>
                    <span style="color: #9e9e9e"> File size </span>
                  </div>
                </div>
              </div>
              <div class="card my-3" style="max-width: 350px">
                <div class="card-body">
                  <div class="d-flex flex-column">
                    <b style="font-weight: 500">File name</b>
                    <span style="color: #9e9e9e"> File size </span>
                  </div>
                </div>
              </div>
              <div class="card my-3" style="max-width: 350px">
                <div class="card-body">
                  <div class="d-flex flex-column">
                    <b style="font-weight: 500">File name</b>
                    <span style="color: #9e9e9e"> File size </span>
                  </div>
                </div>
              </div>
              {% endcomment %}

              <div class="row mb-3" id="lessonAttachmentsPreviewContainer"></div>

              <select class="d-none" id="lesson-attachments" name="attachments" multiple>
              </select>
              <button class="btn btn-outline-primary p-3" id="lesson-attachments-btn" type="button">
                <i class="far fa-paperclip"></i>&nbsp;&nbsp;<span>Upload Attachments</span>
              </button>
            </div>

            <div class="d-flex align-items-center gap-3 mb-4">
              <input type="checkbox" id="lesson-enable_preview" name="enable_preview" class="form-check-input"
                style="padding: 10px" />
              <label for="enable_preview">Enable Course Preview:</label>
            </div>
            <small class="text-muted">
              <i class="fal fa-info-circle"></i> If checked, any users/guest
              can view this lesson without enroll course
            </small>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Assignment -->
  <div class="modal fade" id="assignmentModal" tabindex="-1" aria-labelledby="assignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="assignmentModalLabel">
            Assignment
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="assignment-form">
          {% csrf_token %}
          <div class="modal-body px-4">
            <div class="form-outline mb-3">
              <label class="form-label my-2 fw-bold">Assignment Name</label>
              <input type="text" id="assignment-title" name="title" class="form-control p-3 mb-2" value="test title"
                required />
            </div>

            <div class="form-outline mb-4">
              <label class="form-label my-2 fw-bold">Summary</label>
              <textarea id="assignment-summary-editor">
              </textarea>
            </div>

            <div class="form-outline mb-4">
              <label class="form-label my-2 fw-bold">Attachments</label>
              <br>

              {% comment %} <div class="card my-3" style="max-width: 350px">
                <div class="card-body">
                  <div class="d-flex flex-column">
                    <b style="font-weight: 500">File name</b>
                    <span style="color: #9e9e9e"> File size </span>
                  </div>
                </div>
              </div>
              <div class="card my-3" style="max-width: 350px">
                <div class="card-body">
                  <div class="d-flex flex-column">
                    <b style="font-weight: 500">File name</b>
                    <span style="color: #9e9e9e"> File size </span>
                  </div>
                </div>
              </div>
              <div class="card my-3" style="max-width: 350px">
                <div class="card-body">
                  <div class="d-flex flex-column">
                    <b style="font-weight: 500">File name</b>
                    <span style="color: #9e9e9e"> File size </span>
                  </div>
                </div>
              </div> {% endcomment %}

              <div class="row mb-3" id="assignmentAttachmentsPreviewContainer"></div>

              <select class="d-none" id="assignment-attachments" name="attachments" multiple></select>
              <button class="btn btn-outline-primary p-3" type="button" id="assignment-attachments-btn">
                <i class="far fa-paperclip"></i>&nbsp;&nbsp;<span>Upload Attachments</span>
              </button>
            </div>

            <div class="py-2" style="max-width: 350px">
              <div class="form-outline mb-3">
                <label class="form-label my-2 fw-bold">Time Limit</label>
                <div class="d-flex gap-3 align-content-center">
                  <input type="number" id="assignment-time_limit" name="time_limit" class="form-control p-3 mb-2"
                    placeholder="Time Limit" value="0" min="0" />

                  <select class="course-difficulty-single form-select p-3 mb-2" id="assignment-time_limit_unit">
                    <option value="W" selected>Weeks</option>
                    <option value="D">Days</option>
                    <option value="H">Hours</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="py-2" style="max-width: 350px">
              <div class="form-outline mb-3">
                <label class="form-label my-2 fw-bold">Total Points</label>
                <input type="number" id="assignment-total_points" name="time_limit" class="form-control p-3 mb-2"
                  placeholder="Time Limit" value="10" min="0" />
                <small class="text-muted">
                  <i class="fal fa-info-circle"></i> Maximum points a student
                  can score
                </small>
              </div>
            </div>

            <div class="py-2" style="max-width: 350px">
              <div class="form-outline mb-3">
                <label class="form-label my-2 fw-bold">Minimum Passing Points</label>
                <input type="number" id="assignment-min_pass_points" name="time_limit" class="form-control p-3 mb-2"
                  placeholder="Time Limit" value="5" min="0" />
                <small class="text-muted">
                  <i class="fal fa-info-circle"></i> Minimum points required
                  for the student to pass this assignment.
                </small>
              </div>
            </div>

            <div class="py-2" style="max-width: 350px">
              <div class="form-outline mb-3">
                <label class="form-label my-2 fw-bold">Maximum File Uploads</label>
                <input type="number" id="assignment-max_file_uploads" name="time_limit" class="form-control p-3 mb-2"
                  placeholder="Time Limit" value="1" min="0" />
                <small class="text-muted">
                  <i class="fal fa-info-circle"></i> Define the number of
                  files that a student can upload in this assignment. Input 0
                  to disable the option to upload.
                </small>
              </div>
            </div>

            <div class="py-2" style="max-width: 350px">
              <div class="form-outline mb-3">
                <label class="form-label my-2 fw-bold">File Size Limit</label>
                <input type="number" id="assignment-file_size_limit" name="time_limit" class="form-control p-3 mb-2"
                  placeholder="Time Limit" value="2" min="0" />
                <small class="text-muted">
                  <i class="fal fa-info-circle"></i> Define maximum file size
                  attachment in MB
                </small>
              </div>
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Close
            </button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="{% static 'js/script.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
  <script>

    // [
    //    {
    //       "id":1,
    //       "topic_items": [
    //              {
    //                 "id":1,
    //                 "lesson": {
    //                    "id":1,
    //                    "title":"Lesson 1",
    //                    "summary":"Lesson 1 summary",
    //                    "feature_image":null,
    //                    "content":"<p>Lesson 1 content<\/p>",
    //                    "attachments":[
    //                       {
    //                          "id":1,
    //                          "file":"http://.."
    //                       }
    //                    ],
    //                  "enable_preview":false,
    //                 },
    //                 "quiz":null,
    //                 "assignment":null,
    //                 "sort_order":1
    //              },
    //              ...
    //          ],
    //    },
    //    ...
    // ]

    topics_state = [];

    // Function to fetch and display the topics list
    function fetchTopicsList() {
      topics_state.length = 0;
      const url = "{% url 'courses:list_topics' course.pk %}";

      $.ajax({
        type: "GET",
        url: url,
        success: function (response) {
          const topicList = response.topics;
          const topicListContainer = $("#topic-list #topicsList");
          topicListContainer.empty();

          topicList.forEach(function (topic, index) {
            const topicsList = `
              <div class="card bg-light text-start mb-3" data-topic-id="${topic.id}">
                <div class="card-body p-0">
                    <div class="section px-2 py-3 d-flex align-items-center justify-content-between">
                        <span class="fs-6 SortHandle" style="cursor: grab;"><i class="fal fa-bars"></i>&nbsp;&nbsp;${topic.title}</span>
                        <span class="d-flex gap-2 px-2">
                            <button type="button" class="btn btn-sm editTopicButton" data-bs-toggle="modal" data-bs-target="#updateTopicModal" data-bs-topic-sort="${topic.sort_order}" data-bs-topic-id="${topic.id}" data-bs-topic-title="${topic.title}" data-bs-topic-summary="${topic.summary}"><i class="fas fa-edit text-muted"></i></button>
                            <button type="button" class="btn btn-sm"><i class="fas fa-trash-alt text-muted"></i></button>
                            <button type="button" class="btn btn-sm" data-bs-toggle="collapse" href="#topic-${topic.id}"><i class="fas fa-chevron-down text-muted"></i></button>
                        </span>
                    </div>
                    
                    <div class="collapse show" id="topic-${topic.id}">
                        <div class="card card-body">

                            <div class="topicItems-${topic.id}"></div>

                            <div class="d-flex gap-3">
                                <!-- Button for Add Lesson -->
                                <button type="button" class="btn btn-outline-primary create-lesson-button" data-bs-toggle="modal" data-bs-target="#lessonModal" data-topic-id="${topic.id}">
                                  <i class="fas fa-plus-square"></i>
                                    &nbsp;Lesson
                                </button>

                                <!-- Button for Add Quiz -->
                                <button type="button" data-bs-toggle="modal" data-bs-target="#quizModalStep1" class="btn btn-outline-primary" data-topic-id="${topic.id}">
                                    <i class="fas fa-plus-square"></i>
                                    &nbsp;Quiz
                                </button>

                                <!-- Button for Add Assignment -->
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignmentModal" data-topic-id="${topic.id}">
                                  <i class="fas fa-plus-square"></i>
                                    &nbsp;Assignment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
              </div>
              
              

              `;

            topicListContainer.append(topicsList);

            // Get topic items
            $.ajax({
              type: "GET",
              url: `/courses/list-topic-item/${topic.id}/`,
              headers: {
                "X-CSRFToken": "{{ csrf_token }}",
              },
              success: function (response) {
                console.log(topic.id);
                console.log(response.data);
                const topicItems = response.data;
                const topicItemsContainer = $(`.topicItems-${topic.id}`);
                topicItemsContainer.empty();

                topics_state.push({
                  topic_id: topic.id,
                  topic_items: topicItems,
                });
                topicItems.forEach(function (item, index) {

                  topicItemList = "";

                  if (item.lesson != null) {
                    topicItemList = `
                    <div class="card bg-white text-start mb-3" data-topic-id="${topic.id}" data-topic-item-id="${item.id}">
                      <div class="card-body p-0">
                        <div class="section p-2 d-flex align-items-center justify-content-between"
                        style="cursor: pointer;">
                            <span class="fs-6 topic-item-SortHandle"><i class="fal fa-bars"></i>&nbsp;&nbsp;Lesson: ${item.lesson_data.title}</span>
                            <span class="d-flex gap-2 px-2">
                              <button type="button" class="btn btn-sm editTopicButton" data-bs-toggle="modal" data-bs-target="#lessonModal" data-topic-id="${topic.id}" data-topic-item-id="${item.id}"><i class="fas fa-edit text-muted"></i></button>
                              <button type="button" class="btn btn-sm"><i class="fas fa-trash-alt text-muted"></i></button>
                            </span>
                        </div>
                      </div>
                    </div>
                    `;
                  }
                  else if (item.assignment) {
                    topicItemList = `
                    <div class="card bg-white text-start mb-3" data-topic-id="${topic.id}" data-topic-item-id="${item.id}">
                      <div class="card-body p-0">
                        <div class="section p-2 d-flex align-items-center justify-content-between"
                        style="cursor: pointer;">
                            <span class="fs-6 topic-item-SortHandle"><i class="fal fa-bars"></i>&nbsp;&nbsp;Assignment: ${item.assignment_data.title}</span>
                            <span class="d-flex gap-2 px-2">
                              <button type="button" class="btn btn-sm editTopicButton" data-bs-toggle="modal" data-bs-target="#assignmentModal" data-topic-id="${topic.id}" data-topic-item-id="${item.id}"><i class="fas fa-edit text-muted"></i></button>
                              <button type="button" class="btn btn-sm"><i class="fas fa-trash-alt text-muted"></i></button>
                            </span>
                        </div>
                      </div>
                    </div>
                    `;
                  }
                  else if (item.quiz) {
                    topicItemList = `
                    <div class="card bg-white text-start mb-3" data-topic-id="${topic.id}" data-topic-item-id="${item.id}">
                      <div class="card-body p-0">
                        <div class="section p-2 d-flex align-items-center justify-content-between"
                        style="cursor: pointer;">
                            <span class="fs-6 topic-item-SortHandle"><i class="fal fa-bars"></i>&nbsp;&nbsp;Quiz: ${item.quiz_data.title}</span>
                            <span class="d-flex gap-2 px-2">
                              <button type="button" class="btn btn-sm editTopicButton" data-bs-toggle="modal" data-bs-target="#quizModalStep1" data-topic-id="${topic.id}" data-topic-item-id="${item.id}"><i class="fas fa-edit text-muted"></i></button>
                              <button type="button" class="btn btn-sm"><i class="fas fa-trash-alt text-muted"></i></button>
                            </span>
                        </div>
                      </div>
                    </div>
                    `;
                  }

                  topicItemsContainer.append(topicItemList);
                });



                // Sortable Topic item list
                const sortableTopicList = new Sortable(
                  document.querySelector(`.topicItems-${topic.id}`),
                  {
                    handle: '.topic-item-SortHandle',
                    animation: 150,
                    onEnd: function (evt) {
                      const item = evt.item;
                      console.log("item", item)
                      const newIndex = evt.newIndex;
                      console.log("index", newIndex)

                      const topic_id = item.getAttribute("data-topic-id");
                      const topic_item_id = item.getAttribute("data-topic-item-id");
                      console.log("topic id and topic item id", topic_id, topic_item_id)
                      const topic = topics_state.find((topic) => topic.topic_id == topic_id);
                      console.log("topic", topic)
                      const topic_item = topic.topic_items.find((item) => item.id == topic_item_id);
                      console.log("topic_item", topic_item)

                      let url = "";
                      let data = {};
                      if (topic_item.lesson){
                        url = `/courses/update-lesson/${topic_item.lesson}/`;
                        data = {...topic_item.lesson_data, sort_order: newIndex + 1,};
                      }
                      else if (topic_item.assignment){
                        url = `/courses/update-assignment/${topic_item.assignment}/`;
                        data = {...topic_item.assignment_data, sort_order: newIndex + 1,};
                      }
                      else if (topic_item.quiz){
                        url = `/courses/update-quiz/${topic_item.quiz}/`;
                        data = {...topic_item.quiz_data, sort_order: newIndex + 1,};
                      }
                      $.ajax({
                        url: url,
                        type: "POST",
                        headers: {
                          "X-CSRFToken": "{{ csrf_token }}",
                        },
                        data: JSON.stringify(data),
                        success: function (response) {
                          console.log("successfuly sorted topic item")
                          console.log(response);
                          topic_item.sort_order = newIndex + 1;
                        },
                        error: function (xhr, status, error) {
                          console.log(xhr);
                          console.log(status);
                          console.log(error);
                          // Handle the error and update the UI accordingly
                        },
                      });

                    },
                  }
                );




              },
              error: function (xhr, status, error) {
                console.log(xhr);
                console.log(status);
                console.log(error);
                alert("Error: " + xhr.responseJSON.error);
                // Handle the error and update the UI accordingly
              },
            });
          });
        },
        error: function (xhr, status, error) {
          alert("Error fetching topic list.");
        },
      });
    }

    // Active quiz's questions state
    // [
    //      {
    //        answer_required: false,
    //        description: "qwe",
    //        display_points: false,
    //        fb_correct_answer: "",
    //        fb_question_title: "",
    //        id: 4,
    //        points: 1,
    //        randomize_options: false,
    //        sort_order: 1,
    //        tf_correct_answer: true,
    //        tf_true_first: true,
    //        title: "Q1",
    //        type: "TF",
    //      },
    // ]

    questions_state = [];

    function fetchQuizQuestions(quizID, success_handler) {
      const url = `/courses/list-questions/${quizID}/`;
      $.ajax({
        type: "GET",
        url: url,
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
        success: function (response) {
          console.log("Questions", response);
          questions_state = response.data;

          $("#quiz-questions-container").empty();
          for (const question of response.data) {
            const currQuestionType = questionTypes[question.type];
            $("#quiz-questions-container").append(`
              <div class="border mb-3 px-2 py-2 rounded d-flex align-items-center justify-content-between" data-quiz-id="${quizID}" data-question-id="${question.id}">
                <span class="fs-6 question-SortHandle" style="cursor: grab;"><i
                    class="fal fa-grip-vertical text-muted mx-2"></i>&nbsp;&nbsp;${question.title}
                  </span>
                <span class="d-flex gap-3 align-items-center">
                  <div class="px-2">
                    <button class="btn btn-outline-primary border rounded" type="button"
                      style="background-color: ${currQuestionType.color}; color: white;" aria-expanded="false">
                      <i class="${currQuestionType.icon}"></i>
                    </button>
                  </div>
                  <div class="dropdown">
                    <button class="btn btn-outline-primary border rounded-circle dropdown-toggl" type="button"
                      data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fal fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                      <li>
                        <a class="dropdown-item p-3" href="#" data-quiz-id="${quizID}" data-question-id="${question.id}" data-bs-toggle="modal"
                        data-bs-target="#questionModal">
                          <i class="far fa-edit">&nbsp;&nbsp;</i> Edit
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item p-3" href="#">
                          <i class="fal fa-trash">&nbsp;&nbsp;</i> Delete
                        </a>
                      </li>
                    </ul>
                  </div>
                </span>
              </div>
            `);
          }

          // Sortable Quiz Questions
          const sortableQuizQuestions = new Sortable(
                  document.querySelector(`#quiz-questions-container`),
                  {
                    handle: '.question-SortHandle',
                    animation: 150,
                    onEnd: function (evt) {
                      const item = evt.item;
                      console.log("item", item)
                      const newIndex = evt.newIndex;
                      console.log("index", newIndex)

                      const quiz_id = item.getAttribute("data-quiz-id");
                      const question_id = item.getAttribute("data-question-id");
                      console.log("quiz id and question id", quiz_id, question_id)
                      const question = questions_state.find((ques) => ques.id == question_id);
                      console.log("question", question)

                      let url = `/courses/update-question/${question_id}/`;
                      let data = {...question, sort_order: newIndex + 1,};
                      $.ajax({
                        url: url,
                        type: "POST",
                        headers: {
                          "X-CSRFToken": "{{ csrf_token }}",
                        },
                        data: JSON.stringify(data),
                        success: function (response) {
                          console.log("successfuly sorted question")
                          console.log(response);
                          question.sort_order = newIndex + 1;
                        },
                        error: function (xhr, status, error) {
                          console.log(xhr);
                          console.log(status);
                          console.log(error);
                          // Handle the error and update the UI accordingly
                        },
                      });

                    },
                  }
                );


          if (success_handler) {
            success_handler();
          }

        },
        error: function (xhr, status, error) {
          console.log(xhr);
          console.log(status);
          console.log(error);
          alert("Error: " + xhr.responseJSON.error);
          // Handle the error and update the UI accordingly
        },
      });
    }







    $("#search-instructor-js").keyup(function (event) {
      if (event.key === "Enter") {
        $.ajax({
          type: "GET",
          url: "{% url 'users:search_instructors' course.pk %}",
          data: {
            'q': $("#search-instructor-js").val()
          },
          success: function (data) {
            $("#instructor-list-js").empty();
            console.log(data)
            for (const i of data.data) {
              console.log("instructor", i)
              $("#instructor-list-js").append(`
                <div 
                  class="card mb-3 instructor-item-js" 
                  style="max-width: 350px" 
                  data-user-id="${i.id}"
                  data-user-first-name="${i.first_name}"
                  data-user-last-name="${i.last_name}"
                  data-user-email="${i.email}" 
                >
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-3 gap-lg-4">
                      <img
                        style="width: 48px; border-radius: 100%"
                        src="https://www.gravatar.com/avatar/cd935c35ae34731f14609bc53055aec6?s=150&r=g&d=mm"
                        alt="user photo"
                      />
                      <div class="d-flex flex-column">
                        <b>${i.first_name} ${i.last_name} </b>
                        <b style="color: #9e9e9e"> ${i.email} </b>
                      </div>
                    </div>
                  </div>
                </div>
                `);
            }
            $(".instructor-item-js").click(function () {
              // Select the select element by its ID
              var selectElement = $('#instructors-js');

              // Create a new option element and set the selected attribute
              var newOption = $('<option>', {
                value: $(this).attr("data-user-id"),
                text: "",
                selected: true // Set the selected attribute to keep it selected
              });

              // Append the new option element to the select element
              selectElement.append(newOption);

              $("#display-instructors-list-js").append(`
                <div class="col-lg-6">
                  <div class="card mb-4">
                      <div class="card-body">
                          <div class="d-flex align-items-center gap-3 gap-lg-4">
                              <img style="width: 48px; border-radius: 100%;"
                                  src="https://www.gravatar.com/avatar/cd935c35ae34731f14609bc53055aec6?s=150&r=g&d=mm"
                                  alt="user photo">
                              <div class="d-flex flex-column">
                                  <b class="greet-text">${$(this).attr("data-user-first-name")} ${$(this).attr("data-user-last-name")}
                                  </b>
                                  <b style="color: #9e9e9e;">
                                      ${$(this).attr("data-user-email")}
                                  </b>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
                `);

              $("#instructor-list-js").empty();
              $("#search-instructor-js").val("");
              $('#instructorModal').modal('hide');
            });
          },
          error: function (xhr, status, error) {
            console.error(error);
          }
        });

      }
    });

    $("#courseForm").on("submit", function (event) {
      const hourInput = $("#hour-js");
      const minuteInput = $("#minute-js");
      const durationInput = $("#duration-js");

      const hour = parseInt(hourInput.val() || 0);
      const minute = parseInt(minuteInput.val() || 0);

      const formattedTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:00`;
      console.log(formattedTime);

      durationInput.val(formattedTime);
    });


    $(".section").click(function () {
      $(this).children(".fas").toggleClass("fa-chevron-up fa-chevron-down");
    });

    const lessonModal = document.getElementById("lessonModal");
    ClassicEditor.create(document.querySelector("#lesson-content-editor")).then(editor => {
      console.log("CKEditor initialized");
      createLessonContentEditor = editor;
    })
      .catch(error => {
        console.error(error);
      });;

    lessonTopicId = "";
    activeLessonId = "";
    lessonModal.addEventListener("show.bs.modal", (event) => {
      const button = event.relatedTarget;
      const selectedTopicId = button.getAttribute("data-topic-id");
      lessonTopicId = selectedTopicId;
      //get state object
      const top = topics_state.find(topic => topic.topic_id == selectedTopicId);
      const item = top.topic_items.find(item => item.id == button.getAttribute("data-topic-item-id"));
      activeLessonId = "";
      console.log(item);
      if (item) {
        activeLessonId = item.lesson;
        const lessonId = item.lesson_data.id;
        const lessonTitle = item.lesson_data.title;
        const lessonContent = item.lesson_data.content;
        const lessonFeatureImage = item.lesson_data.feature_image_data;
        const lessonAttachments = item.lesson_data.attachments_data;
        const lessonEnablePreview = item.lesson_data.enable_preview;

        $("#lesson-title").val(lessonTitle);
        createLessonContentEditor.setData(lessonContent);
        if (lessonFeatureImage) {
          var newOption = $('<option>', {
            value: lessonFeatureImage.id,
            text: "",
            selected: true // Set the selected attribute to keep it selected
          });
          $("#lesson-feature_image").append(newOption);
          $("#lesson-feature-image-preview").attr("src", lessonFeatureImage.file);
        }
        else {
          $("#lesson-feature_image").empty();
          $("#lesson-feature-image-preview").attr("src", "{% static 'images/thumbnail-placeholder.svg' %}");
        }

        if (lessonAttachments.length > 0) {
          lessonAttachments.forEach(function (attachment, index) {
            var newOption = $('<option>', {
              value: attachment.id,
              text: "",
              selected: true // Set the selected attribute to keep it selected
            });
            $("#lesson-attachments").append(newOption);
          });
        }
        else {
          $("#lesson-attachments").empty();
        }
        $("#lesson-enable_preview").prop('checked', lessonEnablePreview);
        $("#lessonAttachmentsPreviewContainer").empty();
        lessonAttachments.forEach(function (attachment, index) {
          $("#lessonAttachmentsPreviewContainer").append(`
                <div class="col-md-4">
                  <div class="card">
                      <div class="card-body">
                          <div class="d-flex align-items-center">
                              <div class="text-truncate p-3" style="max-width: 90%; font-weight: bold;">
                              ${attachment.file.replace(/^.*[\\\/]/, '')}<br>
                                  <span class="text-muted" style="font-weight: normal;">Size: ${attachment.size}</span>
                              </div>
                              <button class="btn btn-outline-primary border rounded-circle" 
                                  type="button" data-media-id="${attachment.id}" onclick="remove_lesson_attachment(this)"
                                  aria-expanded="false">
                              <i class="fal fa-times"></i>
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
            `);
        });
      }
      else {
        $("#lesson-title").val("");
        createLessonContentEditor.setData("");
        $("#lesson-feature_image").val("");
        $("#lesson-attachments").val("");
        $("#lesson-enable_preview").prop('checked', false);
        $("#lesson-feature-image-preview").attr("src", "{% static 'images/thumbnail-placeholder.svg' %}");
        $("#lessonAttachmentsPreviewContainer").empty();
      }

    });

    $("#lesson-form").submit(function () {
      event.preventDefault();
      let url = `/courses/create-lesson/${lessonTopicId}/`;
      if (activeLessonId) {
        url = `/courses/update-lesson/${activeLessonId}/`;
      }
      let data = {
        'title': $("#lesson-title").val(),
        'content': createLessonContentEditor.getData(),
        'feature_image': parseInt($("#lesson-feature_image").val()) || null,
        'attachments': $("#lesson-attachments").val().map(val => parseInt(val)),
        'enable_preview': $("#lesson-enable_preview").prop('checked'),
      };

      $.ajax({
        type: "POST",
        url: url,
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        data: JSON.stringify(data),

        success: function (data) {
          console.log(data);
          $("#lessonModal").modal("hide");
          $("#lesson-title").val("");
          createLessonContentEditor.setData("");
          $("#lesson-feature_image").val("");
          $("#lesson-attachments").val("");
          $("#lesson-enable_preview").prop('checked', false);
          $("#lesson-feature-image-preview").attr("src", "{% static 'images/thumbnail-placeholder.svg' %}");
          $("#lessonAttachmentsPreviewContainer").empty();


          // Get topic items
          fetchTopicsList();





        },
        error: function (xhr, status, error) {
          console.error(error);
        }
      });

    });


    const assignmentModal = document.getElementById("assignmentModal");
    ClassicEditor.create(document.querySelector("#assignment-summary-editor")).then(editor => {
      console.log("CKEditor initialized");
      createAssignmentSummaryEditor = editor;
    })
      .catch(error => {
        console.error(error);
      });

    assignmentTopicId = "";
    activeAssignmentId = "";
    assignmentModal.addEventListener("show.bs.modal", (event) => {
      const button = event.relatedTarget;
      const selectedTopicId = button.getAttribute("data-topic-id");
      assignmentTopicId = selectedTopicId;
      //get state object
      const top = topics_state.find(topic => topic.topic_id == selectedTopicId);
      const item = top.topic_items.find(item => item.id == button.getAttribute("data-topic-item-id"));
      activeAssignmentId = "";
      console.log(topics_state)
      console.log(item);
      if (item) {
        activeAssignmentId = item.assignment;
        const assignmentId = item.assignment_data.id;
        const assignmentTitle = item.assignment_data.title;
        const assignmentSummary = item.assignment_data.summary;
        const assignmentAttachments = item.assignment_data.attachments_data;
        const assignmentTimeLimit = item.assignment_data.time_limit_hours;
        const assignmentTimeLimitUnit = item.assignment_data.time_limit_unit;
        const assignmentTotalPoints = item.assignment_data.total_points;
        const assignmentMinPassPoints = item.assignment_data.min_pass_points;
        const assignmentMaxFileUploads = item.assignment_data.max_file_uploads;
        const assignmentFileSizeLimit = item.assignment_data.file_size_limit;


        $("#assignment-title").val(assignmentTitle);
        createAssignmentSummaryEditor.setData(assignmentSummary);
        if (assignmentAttachments.length > 0) {
          assignmentAttachments.forEach(function (attachment, index) {
            var newOption = $('<option>', {
              value: attachment.id,
              text: "",
              selected: true // Set the selected attribute to keep it selected
            });
            $("#assignment-attachments").append(newOption);
          });
        }
        else {
          $("#assignment-attachments").empty();
        }

        if (assignmentTimeLimitUnit == "D") {
          $("#assignment-time_limit").val(assignmentTimeLimit / 24);
        }
        else if (assignmentTimeLimitUnit == "W") {
          $("#assignment-time_limit").val(assignmentTimeLimit / 24 / 7);
        }
        else {
          $("#assignment-time_limit").val(assignmentTimeLimit);
        }
        $("#assignment-time_limit_unit").val(assignmentTimeLimitUnit);
        $("#assignment-total_points").val(assignmentTotalPoints);
        $("#assignment-min_pass_points").val(assignmentMinPassPoints);
        $("#assignment-max_file_uploads").val(assignmentMaxFileUploads);
        $("#assignment-file_size_limit").val(assignmentFileSizeLimit);
        $("#assignmentAttachmentsPreviewContainer").empty();
        assignmentAttachments.forEach(function (attachment, index) {
          $("#assignmentAttachmentsPreviewContainer").append(`
                  <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="text-truncate p-3" style="max-width: 90%; font-weight: bold;">
                                ${attachment.file.replace(/^.*[\\\/]/, '')}<br>
                                    <span class="text-muted" style="font-weight: normal;">Size: ${attachment.size}</span>
                                </div>
                                <button class="btn btn-outline-primary border rounded-circle" 
                                    type="button" data-media-id="${attachment.id}" onclick="remove_assignment_attachment(this)"
                                    aria-expanded="false">
                                <i class="fal fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
          `);
        });

      }
      else {
        $("#assignment-title").val("");
        createAssignmentSummaryEditor.setData("");
        $("#assignment-attachments").val("");
        $("#assignment-time_limit").val("0");
        $("#assignment-time_limit_unit").val("W");
        $("#assignment-total_points").val("10");
        $("#assignment-min_pass_points").val("5");
        $("#assignment-max_file_uploads").val("1");
        $("#assignment-file_size_limit").val("2");
        $("#assignmentAttachmentsPreviewContainer").empty();
      }
    });


    $("#assignment-form").submit(function () {
      event.preventDefault();
      let url = `/courses/create-assignment/${assignmentTopicId}/`;
      if (activeAssignmentId) {
        url = `/courses/update-assignment/${activeAssignmentId}/`;
      }
      let data = {
        'title': $("#assignment-title").val(),
        'summary': createAssignmentSummaryEditor.getData(),
        'attachments': $("#assignment-attachments").val().map(val => parseInt(val)),
        'time_limit_unit': $("#assignment-time_limit_unit").val(),
        'total_points': parseInt($("#assignment-total_points").val()),
        'min_pass_points': parseInt($("#assignment-min_pass_points").val()),
        'max_file_uploads': parseInt($("#assignment-max_file_uploads").val()),
        'file_size_limit': parseInt($("#assignment-file_size_limit").val()),
      };
      let time_limit = parseInt($("#assignment-time_limit").val())
      if (data["time_limit_unit"] == "D") {
        time_limit = time_limit * 24;
      }
      else if (data["time_limit_unit"] == "W") {
        time_limit = time_limit * 24 * 7;
      }
      data["time_limit"] = `${time_limit}:00:00`;

      $.ajax({
        type: "POST",
        url: url,
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        data: JSON.stringify(data),

        success: function (data) {
          console.log(data);
          $("#assignmentModal").modal("hide");
          $("#assignment-title").val("");
          createAssignmentSummaryEditor.setData("");
          $("#assignment-attachments").val("");
          $("#assignment-time_limit").val("0");
          $("#assignment-time_limit_unit").val("W");
          $("#assignment-total_points").val("10");
          $("#assignment-min_pass_points").val("5");
          $("#assignment-max_file_uploads").val("1");
          $("#assignment-file_size_limit").val("2");



          fetchTopicsList();





        },
        error: function (xhr, status, error) {
          console.error(error);
        }
      });

    });

    $("#lesson-feature_image-btn").click(function () {
      $("#mediaModal").attr("data-target", "lesson_feature_image");
      $('#mediaModal').modal('show');
    });

    $("#lesson-attachments-btn").click(function () {
      $("#mediaModal").attr("data-target", "lesson_attachments");
      $('#mediaModal').modal('show');
    });

    $("#assignment-attachments-btn").click(function () {
      $("#mediaModal").attr("data-target", "assignment_attachments");
      $('#mediaModal').modal('show');
    });

    function remove_lesson_attachment(btn) {
      console.log(btn)
      const mediaId = $(btn).attr("data-media-id");
      console.log("removing", mediaId)
      const option = $("#lesson-attachments option[value='" + mediaId + "']").first();
      option.remove();
      // Find the closest parent card and remove it
      $(btn).closest(".col-md-4").remove();
    };

    function remove_assignment_attachment(btn) {
      console.log(btn)
      const mediaId = $(btn).attr("data-media-id");
      console.log("removing", mediaId)
      const option = $("#assignment-attachments option[value='" + mediaId + "']").first();
      option.remove();
      // Find the closest parent card and remove it
      $(btn).closest(".col-md-4").remove();
    };


    quizTopicId = "";
    activeQuizId = "";
    const quizModalStep1 = document.getElementById("quizModalStep1");
    quizModalStep1.addEventListener("show.bs.modal", (event) => {
      const button = event.relatedTarget;
      const selectedTopicId = button.getAttribute("data-topic-id");
      quizTopicId = selectedTopicId;
      //get state object
      const top = topics_state.find(topic => topic.topic_id == selectedTopicId);
      const item = top.topic_items.find(item => item.id == button.getAttribute("data-topic-item-id"));
      activeQuizId = "";
      console.log(topics_state)
      console.log(item);
      if (item) {
        activeQuizId = item.quiz;
        const quizId = item.quiz_data.id;
        const quizTitle = item.quiz_data.title;
        const quizSummary = item.quiz_data.summary;

        $("#quiz-title").val(quizTitle);
        $("#quiz-summary").val(quizSummary);
      }
      else {
        $("#quiz-title").val("");
        $("#quiz-summary").val("");
      }
    });

    $("#quizFormStep1").submit(function () {
      event.preventDefault();
      let url = `/courses/create-quiz/${quizTopicId}/`;
      if (activeQuizId) {
        url = `/courses/update-quiz/${activeQuizId}/`;
      }
      let data = {
        'title': $("#quiz-title").val(),
        'summary': $("#quiz-summary").val(),
      };

      $.ajax({
        type: "POST",
        url: url,
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        data: JSON.stringify(data),

        success: function (data) {
          console.log(data);
          fetchTopicsList();

          activeQuizId = data.data.id;
          console.log("activeQuizId", activeQuizId)
          console.log("topic item id", data.data.topic_item)
          $("#back-quiz-step2").attr({
            "data-topic-id": quizTopicId,
            "data-topic-item-id": data.data.topic_item,
          });
          $("#save-quiz-step2").attr({
            "data-topic-id": quizTopicId,
            "data-topic-item-id": data.data.topic_item,
          });
          $("#quiz-add-question-btn").attr({
            "data-quiz-id": activeQuizId,
          });

          fetchQuizQuestions(activeQuizId);

          $("#quizModalStep1").modal("hide");
          $("#quizModalStep2").modal("show");
        },
        error: function (xhr, status, error) {
          console.error(error);
        }
      });

    });

    const quizModalStep3 = document.getElementById("quizModalStep3");
    quizModalStep3.addEventListener("show.bs.modal", (event) => {
      const button = event.relatedTarget;
      const selectedTopicId = button.getAttribute("data-topic-id");
      quizTopicId = selectedTopicId;
      //get state object
      const top = topics_state.find(topic => topic.topic_id == selectedTopicId);
      const item = top.topic_items.find(item => item.id == button.getAttribute("data-topic-item-id"));
      activeQuizId = "";
      console.log(topics_state)
      console.log(item);
      if (item) {
        activeQuizId = item.quiz;
        const quizId = item.quiz_data.id;

        const quizTimeLimit = item.quiz_data.time_limit_hours;
        const quizTimeLimitUnit = item.quiz_data.time_limit_unit;
        const quizHideTimeDisplay = item.quiz_data.hide_time_display;
        const quizFeedbackMode = item.quiz_data.feedback_mode;
        const quizMaxAttemptsAllowed = item.quiz_data.max_attempts_allowed;
        const quizPassingPercentage = item.quiz_data.passing_percentage;
        const quizMaxQuestions = item.quiz_data.max_questions;
        const quizAutoStart = item.quiz_data.auto_start;
        const quizQuestionLayout = item.quiz_data.question_layout;
        const quizQuestionOrder = item.quiz_data.question_order;
        const quizHideQuestionNo = item.quiz_data.hide_question_no;
        const quizShortAnsCharLimit = item.quiz_data.short_ans_char_limit;
        const quizLongAnsCharLimit = item.quiz_data.long_ans_char_limit;

        if (quizTimeLimitUnit == "S") {
          $("#quiz-time_limit").val(quizTimeLimit * 60 * 60);
        }
        else if (quizTimeLimitUnit == "M") {
          $("#quiz-time_limit").val(quizTimeLimit * 60);
        }
        else if (quizTimeLimitUnit == "H") {
          $("#quiz-time_limit").val(quizTimeLimit);
        }
        else if (quizTimeLimitUnit == "D") {
          $("#quiz-time_limit").val(quizTimeLimit / 24);
        }
        else if (quizTimeLimitUnit == "W") {
          $("#quiz-time_limit").val(quizTimeLimit / 24 / 7);
        }


        $("#quiz-time_limit_unit").val(quizTimeLimitUnit);
        $("#quiz-hide_time_display").prop('checked', quizHideTimeDisplay);

        if (quizFeedbackMode == "D") {
          $("#quiz-defaultRadio").prop("checked", true);
          $("#quiz-revealModeRadio").prop("checked", false);
          $("#quiz-retryModeRadio").prop("checked", false);
        }
        else if (quizFeedbackMode == "R") {
          $("#quiz-defaultRadio").prop("checked", false);
          $("#quiz-revealModeRadio").prop("checked", true);
          $("#quiz-retryModeRadio").prop("checked", false);
        }
        else if (quizFeedbackMode == "T") {
          $("#quiz-defaultRadio").prop("checked", false);
          $("#quiz-revealModeRadio").prop("checked", false);
          $("#quiz-retryModeRadio").prop("checked", true);
        }

        $(`input[name="quiz-max_attempts_allowed-js"]`).val(quizMaxAttemptsAllowed);
        $("#percentage-label").text(quizMaxAttemptsAllowed);
        $("#quiz-passing_percentage").val(quizPassingPercentage);
        $("#quiz-max_questions").val(quizMaxQuestions);
        $("#quiz-auto_start").prop('checked', quizAutoStart);
        $("#quiz-question_layout").val(quizQuestionLayout);
        $("#quiz-question_order").val(quizQuestionOrder);
        $("#quiz-hide_question_no").prop('checked', quizHideQuestionNo);
        $("#quiz-short_ans_char_limit").val(quizShortAnsCharLimit);
        $("#quiz-long_ans_char_limit").val(quizLongAnsCharLimit);

      }
      else {
        $("#quiz-time_limit").val("0");
        $("#quiz-time_limit_unit").val("W");
        $("#quiz-hide_time_display").prop('checked', false);

        $("#quiz-defaultRadio").prop("checked", true);
        $("#quiz-revealModeRadio").prop("checked", false);
        $("#quiz-retryModeRadio").prop("checked", false);

        $(`input[name="quiz-max_attempts_allowed-js"]`).val("1");
        $("#percentage-label").text("1");
        $("#quiz-passing_percentage").val("80");
        $("#quiz-max_questions").val("10");
        $("#quiz-auto_start").prop('checked', false);
        $("#quiz-question_layout").val("S");
        $("#quiz-question_order").val("R");
        $("#quiz-hide_question_no").prop('checked', false);
        $("#quiz-short_ans_char_limit").val("200");
        $("#quiz-long_ans_char_limit").val("500");
      }

    });

    function secondsToHHMMSS(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;

      const formattedHours = String(hours).padStart(2, '0');
      const formattedMinutes = String(minutes).padStart(2, '0');
      const formattedSeconds = String(remainingSeconds).padStart(2, '0');

      return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
    }

    $("#save-quiz-step3").click(function () {
      event.preventDefault();
      const url = `/courses/update-quiz/${activeQuizId}/`;
      let data = {
        'title': $("#quiz-title").val(),
        'summary': $("#quiz-summary").val(),
        'time_limit_unit': $("#quiz-time_limit_unit").val(),
        'hide_time_display': $("#quiz-hide_time_display").prop('checked'),
        'feedback_mode': $("input[name='quiz-feedback_mode-js']:checked").val(),
        'max_attempts_allowed': $(`input[name="quiz-max_attempts_allowed-js"]`).val(),
        'passing_percentage': $("#quiz-passing_percentage").val(),
        'max_questions': $("#quiz-max_questions").val(),
        'auto_start': $("#quiz-auto_start").prop('checked'),
        'question_layout': $("#quiz-question_layout").val(),
        'question_order': $("#quiz-question_order").val(),
        'hide_question_no': $("#quiz-hide_question_no").prop('checked'),
        'short_ans_char_limit': $("#quiz-short_ans_char_limit").val(),
        'long_ans_char_limit': $("#quiz-long_ans_char_limit").val(),
      };

      let quizTimeLimitUnit = data['time_limit_unit'];
      if (quizTimeLimitUnit == "S") {
        data['time_limit'] = secondsToHHMMSS($("#quiz-time_limit").val());
      }
      else if (quizTimeLimitUnit == "M") {
        data['time_limit'] = secondsToHHMMSS($("#quiz-time_limit").val() * 60);
      }
      else if (quizTimeLimitUnit == "H") {
        data['time_limit'] = secondsToHHMMSS($("#quiz-time_limit").val() * 60 * 60);
      }
      else if (quizTimeLimitUnit == "D") {
        data['time_limit'] = secondsToHHMMSS($("#quiz-time_limit").val() * 60 * 60 * 24);
      }
      else if (quizTimeLimitUnit == "W") {
        data['time_limit'] = secondsToHHMMSS($("#quiz-time_limit").val() * 60 * 60 * 24 * 7);
      }

      $.ajax({
        type: "POST",
        url: url,
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        data: JSON.stringify(data),

        success: function (data) {
          console.log(data);
          fetchTopicsList();

          $("#quizModalStep3").modal("hide");
        },
        error: function (xhr, status, error) {
          console.error(error);
        }
      });
    });

    options_state = [];
    correct_options_state = [];

    quizId = "";
    quizQuestionId = "";
    const questionModal = document.getElementById("questionModal");
    questionModal.addEventListener("show.bs.modal", (event) => {
      const button = event.relatedTarget;
      const selectedQuizId = button.getAttribute("data-quiz-id");
      const selectedQuestionId = button.getAttribute("data-question-id");
      quizId = selectedQuizId;
      quizQuestionId = selectedQuestionId;
      //get state object
      const question = questions_state.find(question => question.id == selectedQuestionId);
      // set field values
      if (question) {
        options_state = question.options_data;
        $("#question-title").val(question.title);
        $("#question-answer_required").prop('checked', question.answer_required);
        $("#question-randomize_options").prop('checked', question.randomize_options);
        $("#question-points").val(question.points);
        $("#question-display_points").prop('checked', question.display_points);

        selectQuestionType(question.type, question);

      }
      else {
        $.ajax({
          url: `/courses/create-question/${quizId}/`,
          type: "POST",
          headers: { "X-CSRFToken": "{{ csrf_token }}" },
          data: JSON.stringify({ title: "New Question" }),
          success: function (data) {
            console.log(data);
            fetchQuizQuestions(quizId);
            quizQuestionId = data.data.id;
            options_state = [];
            selectQuestionType("TF", data.data);

            $("#question-title").val("New Question");
            $("#question-answer_required").prop('checked', false);
            $("#question-randomize_options").prop('checked', false);
            $("#question-points").val("1.0");
            $("#question-display_points").prop('checked', false);
          },
        });

      }

      // Question type widget
      $("#questionTypesContainer").html('');

      $.each(questionTypes, function (key, value) {
        const icon = value.icon;
        const title = value.title;
        const color = value.color;
        const code = value.code;
        const type = title.toLowerCase().replace(/\s+/g, '_');

        const questionTypeDiv = $("<div>").html(
          `<div data-bs-toggle="collapse" href="#questionTypeSelect" style="width: 200px; cursor: pointer;" data-question-type="${code}" class="questionTypeJS">
            <div class="d-flex gap-3 align-items-center rounded border p-2">
              <button class="btn btn-outline-primary border rounded" type="button"
                style="background-color: ${color}; color: white;" aria-expanded="false">
                <i class="${icon}"></i>
              </button>
              <small class="fw-bold text-muted">${title}</small>
            </div>
          </div>`
        );

        $("#questionTypesContainer").append(questionTypeDiv);
      });

      $("#questionTypesContainer").on("click", ".questionTypeJS", function () {
        const questionType = $(this).attr("data-question-type");
        const context = question ? question : {};
        console.log("question, context", question, context)
        selectQuestionType(questionType, context);
      });

    });

    $("#questionForm").submit(function () {
      event.preventDefault();
      let url = `/courses/create-question/${quizId}/`;
      if (quizQuestionId) {
        url = `/courses/update-question/${quizQuestionId}/`;
      }
      let data = {
        'type': $("#selectedTypeJS .questionTypeJS").attr("data-question-type"),
        'title': $("#question-title").val(),
        'answer_required': $("#question-answer_required").prop('checked'),
        'randomize_options': $("#question-randomize_options").prop('checked'),
        'points': parseFloat($("#question-points").val()),
        'display_points': $("#question-display_points").prop('checked'),
        'correct_options': correct_options_state,
      };
      if (data["type"] == "TF") {
        data["tf_correct_answer"] = $("#option-TF-true").prop('checked');
      }
      else if (data["type"] == "FB") {
        data["fb_question_title"] = $("#question-FB-question_title").text();
        data["fb_correct_answer"] = $("#question-FB-correct_answer").text();
      }

      $.ajax({
        type: "POST",
        url: url,
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        data: JSON.stringify(data),

        success: function (data) {
          console.log("Question saved")
          console.log(data);
          fetchQuizQuestions(quizId);
          $("#questionModal").modal("hide");
          $("#quizModalStep2").modal("show");

        },
        error: function (xhr, status, error) {
          console.error(error);
        }
      });

    });





  </script>
</body>

</html>